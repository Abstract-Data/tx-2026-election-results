"""
Comprehensive vulnerability and net change analysis for redistricting.
Analyzes district changes, identifies vulnerabilities, and opportunities for each party.
"""
import pandas as pd
import polars as pl
from pathlib import Path
from typing import Dict, List, Tuple


def load_district_data(district_type: str) -> Tuple[pd.DataFrame, pd.DataFrame, pd.DataFrame]:
    """Load district comparison, gains/losses, and modeled voter data."""
    base_path = Path("data/exports")
    
    # Load comparison data
    comp_file = base_path / "csv" / f"{district_type.lower()}_districts_2022_vs_2026_comparison.csv"
    if comp_file.exists():
        comparison_df = pd.read_csv(comp_file)
    else:
        comparison_df = pd.DataFrame()
    
    # Load gains/losses data
    gains_file = base_path / "csv" / f"{district_type.lower()}_gains_losses_summary.csv"
    if gains_file.exists():
        gains_df = pd.read_csv(gains_file)
    else:
        gains_df = pd.DataFrame()
    
    # Load modeled voters by district
    modeled_file = base_path / "analysis" / "modeled_voters_by_district_type" / f"{district_type.lower()}_modeled_voters_by_district.csv"
    if modeled_file.exists():
        modeled_df = pd.read_csv(modeled_file)
    else:
        modeled_df = pd.DataFrame()
    
    return comparison_df, gains_df, modeled_df


def analyze_vulnerabilities(district_type: str) -> Dict:
    """Analyze vulnerabilities and opportunities for a district type."""
    comparison_df, gains_df, modeled_df = load_district_data(district_type)
    
    if comparison_df.empty:
        return {}
    
    # Merge data
    analysis_df = comparison_df.copy()
    
    # Add modeled voter data if available
    if not modeled_df.empty and "district" in modeled_df.columns:
        # Calculate modeled voters from the data
        # Modeled voters are those marked as "Unknown" (those with GEN history but no primary)
        merge_cols = ["district"]
        rename_dict = {}
        
        if "Unknown" in modeled_df.columns:
            # Total modeled = Unknown voters
            merge_cols.append("Unknown")
            rename_dict["Unknown"] = "total_modeled"
        
        # Also get modeled party breakdown if available
        if "modeled_voters_Republican" in modeled_df.columns:
            merge_cols.append("modeled_voters_Republican")
            rename_dict["modeled_voters_Republican"] = "rep_modeled"
        if "modeled_voters_Democrat" in modeled_df.columns:
            merge_cols.append("modeled_voters_Democrat")
            rename_dict["modeled_voters_Democrat"] = "dem_modeled"
        
        # Only merge columns that exist
        available_cols = [col for col in merge_cols if col in modeled_df.columns]
        if len(available_cols) > 1:  # More than just "district"
            merge_df = modeled_df[available_cols].copy()
            if rename_dict:
                # Only rename columns that exist
                rename_dict_filtered = {k: v for k, v in rename_dict.items() if k in merge_df.columns}
                merge_df = merge_df.rename(columns=rename_dict_filtered)
            
            # Merge
            analysis_df = analysis_df.merge(
                merge_df,
                on="district",
                how="left"
            )
        else:
            # No modeled data columns found
            analysis_df["total_modeled"] = 0
            analysis_df["rep_modeled"] = 0
            analysis_df["dem_modeled"] = 0
        
        # Fill missing values
        if "total_modeled" not in analysis_df.columns:
            analysis_df["total_modeled"] = 0
        if "rep_modeled" not in analysis_df.columns:
            analysis_df["rep_modeled"] = 0
        if "dem_modeled" not in analysis_df.columns:
            analysis_df["dem_modeled"] = 0
        
        analysis_df["total_modeled"] = analysis_df["total_modeled"].fillna(0)
        analysis_df["rep_modeled"] = analysis_df["rep_modeled"].fillna(0)
        analysis_df["dem_modeled"] = analysis_df["dem_modeled"].fillna(0)
        analysis_df["swing_modeled"] = 0
    else:
        analysis_df["total_modeled"] = 0
        analysis_df["rep_modeled"] = 0
        analysis_df["dem_modeled"] = 0
        analysis_df["swing_modeled"] = 0
    
    # Calculate key metrics
    # Net change (voter movement) - calculate from advantage shift if available
    if "advantage_shift" in analysis_df.columns:
        # Parse advantage shift to get net change
        analysis_df["net_advantage_change"] = analysis_df["advantage_shift"]
    elif "net_republican_change" in analysis_df.columns and "net_democrat_change" in analysis_df.columns:
        analysis_df["net_advantage_change"] = (
            analysis_df["net_republican_change"] - analysis_df["net_democrat_change"]
        )
    elif "old_net_advantage" in analysis_df.columns and "new_net_advantage" in analysis_df.columns:
        analysis_df["net_advantage_change"] = (
            analysis_df["new_net_advantage"] - analysis_df["old_net_advantage"]
        )
    else:
        analysis_df["net_advantage_change"] = 0
    
    # Competitive districts (based on 2026 composition)
    # Calculate percentages from voter counts if not available
    if "new_republican_voters" in analysis_df.columns and "new_democrat_voters" in analysis_df.columns:
        total_voters = analysis_df["new_republican_voters"] + analysis_df["new_democrat_voters"]
        analysis_df["rep_pct_2026"] = (analysis_df["new_republican_voters"] / total_voters * 100).fillna(0)
        analysis_df["dem_pct_2026"] = (analysis_df["new_democrat_voters"] / total_voters * 100).fillna(0)
    elif "old_expected_republican_voters" in analysis_df.columns and "old_expected_democrat_voters" in analysis_df.columns:
        # Use old expected as fallback
        total_voters = analysis_df["old_expected_republican_voters"] + analysis_df["old_expected_democrat_voters"]
        analysis_df["rep_pct_2026"] = (analysis_df["old_expected_republican_voters"] / total_voters * 100).fillna(0)
        analysis_df["dem_pct_2026"] = (analysis_df["old_expected_democrat_voters"] / total_voters * 100).fillna(0)
    else:
        # Check multiple possible column names
        rep_pct_col = None
        dem_pct_col = None
        
        for col in ["rep_pct_2026", "new_republican_pct", "republican_pct", "rep_pct"]:
            if col in analysis_df.columns:
                rep_pct_col = col
                break
        
        for col in ["dem_pct_2026", "new_democrat_pct", "democrat_pct", "dem_pct"]:
            if col in analysis_df.columns:
                dem_pct_col = col
                break
        
        if rep_pct_col and dem_pct_col:
            analysis_df["rep_pct_2026"] = analysis_df[rep_pct_col].fillna(0)
            analysis_df["dem_pct_2026"] = analysis_df[dem_pct_col].fillna(0)
        else:
            analysis_df["rep_pct_2026"] = 0
            analysis_df["dem_pct_2026"] = 0
    
    # Calculate competitive districts
    analysis_df["competitive"] = (
        (analysis_df["rep_pct_2026"] >= 45) & (analysis_df["rep_pct_2026"] <= 55) &
        (analysis_df["dem_pct_2026"] >= 45) & (analysis_df["dem_pct_2026"] <= 55)
    ) | (
        abs(analysis_df["rep_pct_2026"] - analysis_df["dem_pct_2026"]) <= 10
    )
    
    # Risk levels based on modeled voters
    # High risk: >50,000 modeled voters, Medium: 25,000-50,000, Low: <25,000
    analysis_df["modeled_risk_level"] = pd.cut(
        analysis_df["total_modeled"],
        bins=[-1, 25000, 50000, float('inf')],
        labels=["Low", "Medium", "High"]
    )
    analysis_df["modeled_risk_level"] = analysis_df["modeled_risk_level"].astype(str)
    
    # High-risk competitive districts (competitive + high modeled voters)
    analysis_df["high_risk_competitive"] = (
        analysis_df["competitive"] & 
        (analysis_df["total_modeled"] > 50000)
    )
    
    # Vulnerable districts for each party
    # Republican vulnerable: Competitive OR (Dem advantage + high modeled)
    # Democrat vulnerable: Competitive OR (Rep advantage + high modeled)
    
    # Determine party advantage from percentages
    analysis_df["current_advantage"] = "Competitive"
    analysis_df.loc[analysis_df["rep_pct_2026"] > analysis_df["dem_pct_2026"] + 5, "current_advantage"] = "Republican"
    analysis_df.loc[analysis_df["dem_pct_2026"] > analysis_df["rep_pct_2026"] + 5, "current_advantage"] = "Democrat"
    
    analysis_df["rep_vulnerable"] = (
        analysis_df["competitive"] |
        (
            (analysis_df["current_advantage"] == "Democrat") &
            (analysis_df["total_modeled"] > 50000)
        )
    )
    analysis_df["dem_vulnerable"] = (
        analysis_df["competitive"] |
        (
            (analysis_df["current_advantage"] == "Republican") &
            (analysis_df["total_modeled"] > 50000)
        )
    )
    
    # Opportunities (districts where party is close but has advantage)
    if "rep_pct_2026" in analysis_df.columns:
        analysis_df["rep_opportunity"] = (
            (analysis_df["rep_pct_2026"] > 50) & 
            (analysis_df["rep_pct_2026"] < 55) &
            (analysis_df["total_modeled"] > 25000)
        )
        analysis_df["dem_opportunity"] = (
            (analysis_df["dem_pct_2026"] > 50) & 
            (analysis_df["dem_pct_2026"] < 55) &
            (analysis_df["total_modeled"] > 25000)
        )
    else:
        analysis_df["rep_opportunity"] = False
        analysis_df["dem_opportunity"] = False
    
    return {
        "data": analysis_df,
        "summary": {
            "total_districts": len(analysis_df),
            "competitive_districts": analysis_df["competitive"].sum(),
            "high_risk_competitive": analysis_df["high_risk_competitive"].sum(),
            "rep_vulnerable": analysis_df["rep_vulnerable"].sum(),
            "dem_vulnerable": analysis_df["dem_vulnerable"].sum(),
            "rep_opportunities": analysis_df["rep_opportunity"].sum(),
            "dem_opportunities": analysis_df["dem_opportunity"].sum(),
            "total_modeled_voters": analysis_df["total_modeled"].sum(),
            "high_risk_districts": (analysis_df["total_modeled"] > 50000).sum(),
            "medium_risk_districts": ((analysis_df["total_modeled"] >= 25000) & (analysis_df["total_modeled"] <= 50000)).sum(),
        }
    }


def generate_vulnerability_report(output_dir: str = "data/exports/analysis/vulnerability_analysis"):
    """Generate comprehensive vulnerability analysis report for all district types."""
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)
    
    print("=" * 100)
    print("REDISTRICTING VULNERABILITY & NET CHANGE ANALYSIS")
    print("=" * 100)
    print()
    
    results = {}
    
    for district_type in ["HD", "CD", "SD"]:
        print(f"\n{'=' * 100}")
        print(f"{district_type} DISTRICTS ANALYSIS")
        print(f"{'=' * 100}\n")
        
        analysis = analyze_vulnerabilities(district_type)
        
        if not analysis:
            print(f"âš ï¸  No data available for {district_type} districts")
            continue
        
        results[district_type] = analysis
        df = analysis["data"]
        summary = analysis["summary"]
        
        # Print summary
        print(f"ðŸ“Š SUMMARY:")
        print(f"   Total Districts: {summary['total_districts']}")
        print(f"   Competitive Districts: {summary['competitive_districts']} ({summary['competitive_districts']/summary['total_districts']*100:.1f}%)")
        print(f"   High-Risk Competitive Districts: {summary['high_risk_competitive']}")
        print(f"   Total Modeled Voters (Secret Voters): {summary['total_modeled_voters']:,.0f}")
        print(f"   High-Risk Districts (>50K modeled voters): {summary['high_risk_districts']}")
        print(f"   Medium-Risk Districts (25K-50K modeled): {summary['medium_risk_districts']}")
        print()
        
        print(f"âš ï¸  VULNERABILITIES:")
        print(f"   Republican Vulnerable Districts: {summary['rep_vulnerable']}")
        print(f"   Democrat Vulnerable Districts: {summary['dem_vulnerable']}")
        print()
        
        print(f"ðŸŽ¯ OPPORTUNITIES:")
        print(f"   Republican Opportunities: {summary['rep_opportunities']}")
        print(f"   Democrat Opportunities: {summary['dem_opportunities']}")
        print()
        
        # Net changes - calculate from available columns
        if "advantage_shift" in df.columns:
            # Calculate from advantage shift
            total_advantage_shift = df["advantage_shift"].sum()
            print(f"ðŸ“ˆ NET CHANGES FROM REDISTRICTING:")
            print(f"   Total Net Advantage Shift: {total_advantage_shift:+,.0f} voters")
            print(f"   (Positive = Republican advantage increased, Negative = Democrat advantage increased)")
            print()
            
            # Districts with largest shifts
            print(f"ðŸ† TOP 5 DISTRICTS - LARGEST ADVANTAGE SHIFTS (Republican Gain):")
            top_shifts = df.nlargest(5, "advantage_shift")[
                ["district", "advantage_shift", "old_advantage_party", "new_advantage_party", "rep_pct_2026", "dem_pct_2026", "total_modeled"]
            ]
            for _, row in top_shifts.iterrows():
                print(f"   District {int(row['district'])}: {row['advantage_shift']:+,.0f} shift "
                      f"({row['old_advantage_party']} â†’ {row['new_advantage_party']}) "
                      f"(Rep: {row['rep_pct_2026']:.1f}%, Dem: {row['dem_pct_2026']:.1f}%, "
                      f"Modeled: {row['total_modeled']:,.0f})")
            print()
            
            print(f"ðŸ† TOP 5 DISTRICTS - LARGEST ADVANTAGE SHIFTS (Democrat Gain):")
            bottom_shifts = df.nsmallest(5, "advantage_shift")[
                ["district", "advantage_shift", "old_advantage_party", "new_advantage_party", "rep_pct_2026", "dem_pct_2026", "total_modeled"]
            ]
            for _, row in bottom_shifts.iterrows():
                print(f"   District {int(row['district'])}: {row['advantage_shift']:+,.0f} shift "
                      f"({row['old_advantage_party']} â†’ {row['new_advantage_party']}) "
                      f"(Rep: {row['rep_pct_2026']:.1f}%, Dem: {row['dem_pct_2026']:.1f}%, "
                      f"Modeled: {row['total_modeled']:,.0f})")
            print()
        elif "net_republican_change" in df.columns:
            total_rep_change = df["net_republican_change"].sum()
            total_dem_change = df["net_democrat_change"].sum()
            net_advantage = total_rep_change - total_dem_change
            
            print(f"ðŸ“ˆ NET CHANGES FROM REDISTRICTING:")
            print(f"   Total Republican Change: {total_rep_change:+,.0f} voters")
            print(f"   Total Democrat Change: {total_dem_change:+,.0f} voters")
            print(f"   Net Advantage: {net_advantage:+,.0f} voters (Republican)")
            print()
            
            # Districts with largest changes
            print(f"ðŸ† TOP 5 DISTRICTS - LARGEST REPUBLICAN GAINS:")
            top_rep_gains = df.nlargest(5, "net_republican_change")[
                ["district", "net_republican_change", "rep_pct_2026", "dem_pct_2026", "total_modeled"]
            ]
            for _, row in top_rep_gains.iterrows():
                print(f"   District {int(row['district'])}: +{row['net_republican_change']:,.0f} voters "
                      f"(Rep: {row['rep_pct_2026']:.1f}%, Dem: {row['dem_pct_2026']:.1f}%, "
                      f"Modeled: {row['total_modeled']:,.0f})")
            print()
            
            print(f"ðŸ† TOP 5 DISTRICTS - LARGEST DEMOCRAT GAINS:")
            top_dem_gains = df.nlargest(5, "net_democrat_change")[
                ["district", "net_democrat_change", "rep_pct_2026", "dem_pct_2026", "total_modeled"]
            ]
            for _, row in top_dem_gains.iterrows():
                print(f"   District {int(row['district'])}: +{row['net_democrat_change']:,.0f} voters "
                      f"(Rep: {row['rep_pct_2026']:.1f}%, Dem: {row['dem_pct_2026']:.1f}%, "
                      f"Modeled: {row['total_modeled']:,.0f})")
            print()
        
        # High-risk competitive districts
        if summary['high_risk_competitive'] > 0:
            print(f"ðŸš¨ HIGH-RISK COMPETITIVE DISTRICTS (Competitive + >50K Modeled Voters):")
            high_risk = df[df["high_risk_competitive"]].sort_values("total_modeled", ascending=False)
            for _, row in high_risk.head(10).iterrows():
                print(f"   District {int(row['district'])}: "
                      f"Rep {row.get('rep_pct_2026', 0):.1f}% / Dem {row.get('dem_pct_2026', 0):.1f}%, "
                      f"{row['total_modeled']:,.0f} modeled voters")
            print()
        
        # Save detailed analysis
        df.to_csv(output_path / f"{district_type.lower()}_vulnerability_analysis.csv", index=False)
        print(f"âœ… Saved detailed analysis to {output_path / f'{district_type.lower()}_vulnerability_analysis.csv'}")
    
    # Create summary report
    summary_data = []
    for district_type, analysis in results.items():
        summary = analysis["summary"]
        summary_data.append({
            "District Type": district_type,
            "Total Districts": summary["total_districts"],
            "Competitive Districts": summary["competitive_districts"],
            "High-Risk Competitive": summary["high_risk_competitive"],
            "Rep Vulnerable": summary["rep_vulnerable"],
            "Dem Vulnerable": summary["dem_vulnerable"],
            "Rep Opportunities": summary["rep_opportunities"],
            "Dem Opportunities": summary["dem_opportunities"],
            "Total Modeled Voters": summary["total_modeled_voters"],
            "High-Risk Districts": summary["high_risk_districts"],
            "Medium-Risk Districts": summary["medium_risk_districts"],
        })
    
    summary_df = pd.DataFrame(summary_data)
    summary_df.to_csv(output_path / "vulnerability_analysis_summary.csv", index=False)
    print(f"\nâœ… Saved summary report to {output_path / 'vulnerability_analysis_summary.csv'}")
    
    return results


if __name__ == "__main__":
    generate_vulnerability_report()

